## 网络防火墙

>主机防火墙只涉及到INPUT和OUTPUT链. 网络防火墙主要就是保护局域网内的主机, 主要功能就是通过FORWARD链做规则转发. 所以网络防火墙的规则大部分都在FORWARD中.

### 本页大纲

* [测试环境](#测试环境)
* [如何设置](#如何设置)

### 测试环境

```
                                +---------------------------------------------------------+
                                |                                                         |
         ^--------------------+ |                                                         |
A        +--------------------> |   B    +---------------------------->  C                |
192.168.89.1/24                 |   192.168.89.110/24                    10.1.0.3/16      |
                                |   10.1.0.2/16                                           |
                                |         <---------------------------+                   |
                                |                                                         |
                                +---------------------------------------------------------+
```

 A,B,C三个主机, B做为(10.1.0.0./16)网段的网络防火墙.即(10.1.0.0/16)内的主机要访问外网(比如192.168.89.1/24), 需要通过B网络防火墙的转发. 同理如果A要访问C, 同样需要B的转发.

### 如何设置 

#### 打开B的转发功能

linux默认的转发功能是关闭的. 打开可以使用`sysctl -w net.ipv4.ip_forward=1`打开. 如果想永久有效. 需要修改`/etc/sysctl.conf`文件.

#### 设置路由表

给A中添加静态路由表访问10.0.0.0/16网段通过192.168.89.110地址网关

```
ip route add 10.1.0.0/16 via 192.168.89.110
```

给C中添加静态路由表访问192.168.89.0/24网段通过10.1.0.2地址网关

```
ip route add 192.168.89.0/24 via 10.1.0.2
```

如果想永久有效.可以修改`/etc/network/interfaces`文件, 可能不同发行版修改的位置不同. 这里只是debian的默认设置位置.


#### 设置B转发

因为转发功能是相互的, 又发送就有接受. 所有使用state模块来优化规则, 可以省略许多回应的报文.


```
iptables -t filter -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t filter -A FORWARD -s 10.1.0.0/16 -p tcp --dport 80 -j ACCEPT
iptables -t filter -A FORWARD -s 10.1.0.0/16 -p tcp --dport 22 -j ACCEPT
iptables -t filter -A FORWARD -j REJECT
```

上述转发规则只允许10.1.0.0/16网络内地主机访问外网的80, 22端口. 其他的转发一律屏蔽.那么这样就无法通过外网ping通过内部主机. 但内部主机可以ping通外部主机.